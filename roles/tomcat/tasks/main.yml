---
#tasks file for tomcat

- name: create directory
  file: path="{{item.install_path}}" state=directory
  with_items: "{{configuration}}"

# - name: download and extract binary
#   unarchive: src=http://www-eu.apache.org/dist/tomcat/tomcat-8/v8.5.24/bin/apache-tomcat-8.5.24.tar.gz dest={{item.install_path}} remote_src=True
#   with_items: "{{configuration}}"

- name: create link
  file: src={{item.install_path}}/apache-tomcat-8.5.24 dest={{item.install_path}}/tomcat  state=link
  with_items: "{{configuration}}"

# - name: download java
#   script: "downloadjava.sh {{user_home_dir}}"
# - name: unarchive java
#   unarchive: src=https://edelivery.oracle.com/osdc/softwareDownload?fileName=V77629-01.zip&token=eXFKK3Frc2hiV2NpWE4yWDJzaEREQSE6OiFmaWxlSWQ9ODIwOTQ0MTImZmlsZVNldENpZD04MTQxMjkmcmVsZWFzZUNpZHM9MjUxMTUxJnBsYXRmb3JtQ2lkcz0zNSZkb3dubG9hZFR5cGU9OTU3NjEmYWdyZWVtZW50SWQ9Mzk0MDE2NSZlbWFpbEFkZHJlc3M9aW1hbmtAc2xiLmNvbSZ1c2VyTmFtZT1FUEQtSU1BTktAU0xCLkNPTSZjb3VudHJ5Q29kZT1BRSZzZWFyY2hTdHJpbmc9T3JhY2xlIEpSRQ dest={{user_home_dir}} remote_src=True
# - name: create folder
#   file: path={{user_home_dir}}/jre-8u151 state=directory
- name: unzip java
  file: src={{user_home_dir}}/jre-8u151-linux-x64.tar.gz dest={{user_home_dir}}
- name: create link for java
  file: src={{user_home_dir}}/jre1.8.0_151 dest={{user_home_dir}}/java  state=link

- name: Create environment variable
  template: src=setenv.sh dest={{item.install_path}}/tomcat/bin/setenv.sh  mode=0755
  with_items: "{{configuration}}"

- name: modify server.xml with http and ajp port
  template: src=server.xml dest={{item.install_path}}/tomcat/conf/server.xml
  with_items: "{{configuration}}"
- name: allow manager context accessible from all ip
  replace: path={{item.install_path}}/tomcat/webapps/manager/META-INF/context.xml regexp='0:0:0:0:0:0:0:1"' replace='0:0:0:0:0:0:0:1;\d*|.*;.*"' backup=yes
  with_items: "{{configuration}}"
- name: allow manager context accessible from all ip
  lineinfile: path={{item.install_path}}/tomcat/webapps/manager/META-INF/context.xml insertafter='RemoteAddrValve' line='addConnectorPort="true"' backup=yes
  with_items: "{{configuration}}"

- name: allow host-manager context accessible from all ip
  replace: path={{item.install_path}}/tomcat/webapps/host-manager/META-INF/context.xml regexp='0:0:0:0:0:0:0:1"' replace='0:0:0:0:0:0:0:1;\d*|.*;.*"' backup=yes
  with_items: "{{configuration}}"
- name: allow host-manager context accessible from all ip
  lineinfile: path={{item.install_path}}/tomcat/webapps/host-manager/META-INF/context.xml insertafter='RemoteAddrValve' line='addConnectorPort="true"' backup=yes
  with_items: "{{configuration}}"

- name: enable user
  replace: path={{item.install_path}}/tomcat/conf/tomcat-users.xml regexp='^<!--' replace='#<!--' before='role rolename' backup=yes
  with_items: "{{configuration}}"
- name: enable user
  replace: path={{item.install_path}}/tomcat/conf/tomcat-users.xml regexp='^-->' replace='#-->' before='</tomcat-users>' backup=yes
  with_items: "{{configuration}}"
- name: enable user
  replace: path={{item.install_path}}/tomcat/conf/tomcat-users.xml regexp='password="<must-be-changed>"' replace='password="s3cret"'  backup=yes
  with_items: "{{configuration}}"
- name: role Manager
  lineinfile: path={{item.install_path}}/tomcat/conf/tomcat-users.xml insertafter="rolename="role1"" line="<role rolename="manager-gui"/>" backup=yes
  with_items: "{{configuration}}"
- name: role Manager
  lineinfile: path={{item.install_path}}/tomcat/conf/tomcat-users.xml insertafter="username="role1"" line="<user username="tomcat" password="s3cret" roles="manager-gui"/>" backup=yes
  with_items: "{{configuration}}"





# - name: create directory
#   file: path=~/{{instance_name}}_{{item}} state=directory
#   with_sequence: count=2

# - name: download and extract binary
#   unarchive: src=http://www-eu.apache.org/dist/tomcat/tomcat-8/v8.5.24/bin/apache-tomcat-8.5.24.tar.gz dest=~/{{instance_name}}_{{item}} remote_src=True
#   with_sequence: count=2

# - name: create link
#   file: src=~/{{instance_name}}_{{item}}/apache-tomcat-8.5.24 dest=~/{{instance_name}}_{{item}}/tomcat  state=link
#   with_sequence: count=2

# - name: Create environment variable
#   template: src=setenv.sh dest=~/{{instance_name}}_{{item}}/tomcat/bin/setenv.sh  mode=0755
#   with_sequence: count=2

# - name: unarchive java
#   unarchive: src=jdk-8u121-linux-x64.tar.gz dest=~
# - name: create link for java
#   file: src=~/jre-8u151 dest=~/java  state=link

# - name: modify server.xml with http and ajp port
#   template: src=server.xml dest=~/{{instance_name}}_{{item}}/tomcat/conf/server.xml
#   with_sequence: count=2

# - name: Create Unit file
#   template: src=tomcat.service dest=/etc/systemd/system/tomcat.service mode=644
#   notify:
#     - reload systemctl
#  with_items: instance_1
# - name: move files
#   shell: src=~/{{instance_name}}_{{item}}/apache-tomcat-8.5.11 dest=~/{{instance_name}}_{{item}}/tomcat  state=link
#   with_sequence: count=2

#
# - name: create tomcat user
#   user: name=tomcat  state=present
#
# - name: create link
#   file: src=~/apache-tomcat-8.5.11 dest=~/tomcat owner=tomcat group=root state=link
#
# - name: take ownership
#   command: chown -R tomcat:root /usr/share/{{item}}
#   with_items:
#     - apache-tomcat-8.5.11
#     - jre-8u151



# - name: Create Unit file
#   template: src=tomcat.service dest=/etc/systemd/system/tomcat.service mode=644
#   notify:
#     - reload systemctl
